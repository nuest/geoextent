name: Python package tests

on: [push, pull_request]

jobs:
  test-fast:
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.10', '3.14']
        os: [ubuntu-24.04] # , windows-2019]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
    - name: Cache system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      uses: actions/cache@v3
      with:
        path: |
          /usr/include/gdal
          /usr/lib/x86_64-linux-gnu/libgdal*
          /usr/bin/gdal*
        key: ${{ runner.os }}-gdal-${{ hashFiles('.github/workflows/pythonpackage.yml') }}
        restore-keys: |
          ${{ runner.os }}-gdal-

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
        sudo apt-get update
        sudo apt-get install -y libproj-dev libgeos-dev libspatialite-dev libgdal-dev gdal-bin netcdf-bin
        gdal-config --version

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

    - name: Install GDAL Python bindings matching system library
      if: runner.os == 'Linux'
      run: |
        pip install gdal==$(gdal-config --version)

    - name: Install geoextent and dependencies
      run: |
        pip install -e .[dev,test]
    - name: Check code formatting with black
      run: |
        black --check --diff .
    - name: Test with pytest (fast tests only)
      run: |
        # Uses default addopts: -m "not slow and not large_download"
        pytest -v --tb=short --cov=geoextent --cov-report=xml --cov-report=term-missing

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  test-providers:
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.10', '3.14']
        os: [ubuntu-24.04]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
    - name: Cache system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      uses: actions/cache@v3
      with:
        path: |
          /usr/include/gdal
          /usr/lib/x86_64-linux-gnu/libgdal*
          /usr/bin/gdal*
        key: ${{ runner.os }}-gdal-${{ hashFiles('.github/workflows/pythonpackage.yml') }}
        restore-keys: |
          ${{ runner.os }}-gdal-

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
        sudo apt-get update
        sudo apt-get install -y libproj-dev libgeos-dev libspatialite-dev libgdal-dev gdal-bin netcdf-bin
        gdal-config --version

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

    - name: Install GDAL Python bindings matching system library
      if: runner.os == 'Linux'
      run: |
        pip install gdal==$(gdal-config --version)

    - name: Install geoextent and dependencies
      run: |
        pip install -e .[dev,test]
    - name: Test provider samples (one test per provider)
      run: |
        pytest -v --tb=short -m provider_sample --cov=geoextent --cov-report=xml --cov-report=term-missing

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: provider-sample
        name: codecov-provider-sample
        fail_ci_if_error: false

  verify-test-collection:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.14
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Cache system dependencies
      uses: actions/cache@v3
      with:
        path: |
          /usr/include/gdal
          /usr/lib/x86_64-linux-gnu/libgdal*
          /usr/bin/gdal*
        key: ${{ runner.os }}-gdal-${{ hashFiles('.github/workflows/pythonpackage.yml') }}
        restore-keys: |
          ${{ runner.os }}-gdal-

    - name: Install system dependencies
      run: |
        sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
        sudo apt-get update
        sudo apt-get install -y libproj-dev libgeos-dev libspatialite-dev libgdal-dev gdal-bin netcdf-bin
        gdal-config --version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install gdal==$(gdal-config --version)
        pip install -e .[dev,test]

    - name: Discover and list all tests
      run: |
        echo "=== Discovering all test files ==="
        find tests/ -name "test_*.py" -type f | sort

        echo -e "\n=== Test collection verification ==="
        pytest --collect-only -q | grep "test session starts\|collected"

        echo -e "\n=== Running test collection with detailed output ==="
        pytest --collect-only --tb=short

    - name: Verify no tests are skipped due to missing dependencies
      run: |
        echo "=== Running a dry run to check for import errors ==="
        pytest --collect-only --tb=line 2>&1 | tee test_collection.log

        echo -e "\n=== Checking for common issues ==="
        if grep -i "import.*error\|module.*not.*found\|no.*module.*named" test_collection.log; then
          echo "Found import errors in test collection"
          exit 1
        else
          echo "No import errors found in test collection"
        fi

  test-fast-windows:
    runs-on: windows-latest
    continue-on-error: true
    defaults:
      run:
        shell: bash -el {0}

    steps:
    - uses: actions/checkout@v4

    - name: Enable long paths on Windows
      shell: pwsh
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        python-version: '3.12'
        channels: conda-forge
        channel-priority: strict
        activate-environment: geoextent-test
        miniforge-version: latest

    - name: Cache conda packages
      uses: actions/cache@v3
      with:
        path: ~/conda_pkgs_dir
        key: windows-conda-${{ hashFiles('.github/workflows/pythonpackage.yml') }}
        restore-keys: |
          windows-conda-

    - name: Install GDAL and system deps via conda
      run: |
        conda install -y gdal libgdal libspatialite netcdf4 proj

    - name: Install geoextent in dev mode (no dependency resolution)
      run: |
        pip install --no-deps -e .

    - name: Install runtime dependencies (excluding gdal)
      run: |
        pip install pyproj "geojson>=2.4.1" geojsonio pygeoj pyshp \
          patool python-dateutil pandas "numpy<2" requests traitlets \
          wheel pangaeapy osfclient filesizelib "setuptools-scm>=8" \
          tqdm bs4 geopy python-dotenv humanfriendly crossref-commons \
          datacite owslib

    - name: Install dev and test dependencies
      run: |
        pip install pytest pytest-cov "pytest-xdist[psutil]" \
          pytest-console-scripts geojson-validator black pre-commit

    - name: Verify GDAL import
      run: |
        python -c "from osgeo import gdal; print(f'GDAL {gdal.VersionInfo()}')"

    - name: Test with pytest (fast tests only)
      run: |
        pytest -v --tb=short -n auto -m "not slow and not large_download"

  test-providers-windows:
    runs-on: windows-latest
    continue-on-error: true
    defaults:
      run:
        shell: bash -el {0}

    steps:
    - uses: actions/checkout@v4

    - name: Enable long paths on Windows
      shell: pwsh
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        python-version: '3.12'
        channels: conda-forge
        channel-priority: strict
        activate-environment: geoextent-test
        miniforge-version: latest

    - name: Cache conda packages
      uses: actions/cache@v3
      with:
        path: ~/conda_pkgs_dir
        key: windows-conda-${{ hashFiles('.github/workflows/pythonpackage.yml') }}
        restore-keys: |
          windows-conda-

    - name: Install GDAL and system deps via conda
      run: |
        conda install -y gdal libgdal libspatialite netcdf4 proj

    - name: Install geoextent in dev mode (no dependency resolution)
      run: |
        pip install --no-deps -e .

    - name: Install runtime dependencies (excluding gdal)
      run: |
        pip install pyproj "geojson>=2.4.1" geojsonio pygeoj pyshp \
          patool python-dateutil pandas "numpy<2" requests traitlets \
          wheel pangaeapy osfclient filesizelib "setuptools-scm>=8" \
          tqdm bs4 geopy python-dotenv humanfriendly crossref-commons \
          datacite owslib

    - name: Install dev and test dependencies
      run: |
        pip install pytest pytest-cov "pytest-xdist[psutil]" \
          pytest-console-scripts geojson-validator black pre-commit

    - name: Verify GDAL import
      run: |
        python -c "from osgeo import gdal; print(f'GDAL {gdal.VersionInfo()}')"

    - name: Test provider samples
      run: |
        pytest -v --tb=short -n auto -m provider_sample
